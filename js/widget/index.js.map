{"version":3,"sources":["widget/index.js"],"names":["lodash","filter","find","reject","eachRight","concat","template","omit","Widget","restRoot","restNonce","hierarchy","documentsTotal","currentParentId","dossierHasNoItems","orderBy","dossiers","JSON","parse","root","nonce","current","docuThequeId","noItems","itemsContainer","document","querySelector","docuTheque","breadCrumbs","initialHeaders","pagination","parent","displayedPages","totalItems","totalPages","tmpl","innerHTML","evaluate","interpolate","escape","variable","dossierID","dossier","parents","id","forEach","grandParents","getAllParents","paginaiton","element","dossierId","parseInt","getAttribute","replace","dossierPagination","updatePagination","fetchItems","docuthequeId","docuthequePagination","parentID","children","by","order","ancestors","BreadCrumbTemplate","getTemplate","link","ancestor","index","fetch","method","headers","then","response","get","json","data","results","ItemTemplate","length","result","addEventListener","e","target","nodeName","parentNode","classList","contains","preventDefault","openDossier","openDocutheque","list","listedDocuments","querySelectorAll","scrollHeight","scrollTop","clientHeight","fetchMoreItems","DocuThequesWidget","DocuTheques","settings","readyState","start"],"mappings":"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","file":"index.js","sourceRoot":"..\\src","sourcesContent":["/**\n * External dependencies\n */\nconst { filter, find, reject, eachRight, concat, template, omit } = lodash;\n\n/**\n * Widget.\n */\nclass Widget {\n\tconstructor( { restRoot, restNonce, hierarchy, documentsTotal, currentParentId, dossierHasNoItems, orderBy } ) {\n\t\tthis.dossiers = JSON.parse( hierarchy );\n\t\tthis.root = restRoot;\n\t\tthis.nonce = restNonce;\n\t\tthis.current = currentParentId;\n\t\tthis.docuThequeId = currentParentId;\n\t\tthis.noItems = dossierHasNoItems;\n\t\tthis.itemsContainer = document.querySelector( '.docutheque-elements' );\n\t\tthis.docuTheque = document.querySelector( '.docutheque' );\n\t\tthis.breadCrumbs = document.querySelector( '#fil-ariane-docutheque-' + this.docuThequeId );\n\n\t\tconst initialHeaders = JSON.parse( documentsTotal );\n\t\tthis.pagination = [ {\n\t\t\tparent: currentParentId,\n\t\t\tdisplayedPages: 1,\n\t\t\ttotalItems: initialHeaders['X-WP-Total'],\n\t\t\ttotalPages: initialHeaders['X-WP-TotalPages']\n\t\t} ];\n\n\t\tthis.orderBy = JSON.parse( orderBy );\n\t}\n\n\tgetTemplate( tmpl ) {\n\t\tconst options = {\n\t\t\tevaluate:    /<#([\\s\\S]+?)#>/g,\n\t\t\tinterpolate: /\\{\\{\\{([\\s\\S]+?)\\}\\}\\}/g,\n\t\t\tescape:      /\\{\\{([^\\}]+?)\\}\\}(?!\\})/g,\n\t\t\tvariable:    'data'\n\t\t};\n\n\t\treturn template( document.querySelector( '#tmpl-' + tmpl ).innerHTML, options );\n\t}\n\n\tgetAllParents( dossierID ) {\n\t\tconst dossiers = this.dossiers;\n\t\tlet dossier = find( dossiers, ['id', dossierID ] );\n\t\tlet parents = filter( dossiers, { id: dossier.parent } );\n\n\t\tparents.forEach( ( parent ) => {\n\t\t\tif ( 0 !== parent.parent ) {\n\t\t\t\tconst grandParents = this.getAllParents( parent.id );\n\t\t\t\tparents = [ ...parents, ...grandParents ];\n\t\t\t}\n\t\t} );\n\n\t\treturn reject( parents, [ 'id', this.docuThequeId ] );\n\t}\n\n\tupdatePagination( parent, displayedPages, totalItems, totalPages ) {\n\t\tthis.pagination = [\n\t\t\t...reject( this.paginaiton, [ 'parent', parent ] ),\n\t\t\t{\n\t\t\t\tparent: parent,\n\t\t\t\tdisplayedPages: displayedPages,\n\t\t\t\ttotalItems: totalItems,\n\t\t\t\ttotalPages: totalPages\n\t\t\t}\n\t\t];\n\t}\n\n\topenDossier( element ) {\n\t\tconst dossierId = parseInt( element.getAttribute( 'href' ).replace( '#dossier-', '' ), 10 );\n\t\tconst dossierPagination = find( this.pagination, { parent: dossierId } );\n\n\t\tif ( dossierPagination && dossierPagination.parent ) {\n\t\t\tthis.updatePagination( dossierPagination.parent, 1, dossierPagination.totalItems, dossierPagination.totalPages );\n\t\t}\n\n\t\tthis.itemsContainer.innerHTML = '<li class=\"loading\"></li>';\n\n\t\treturn this.fetchItems( dossierId )\n\t}\n\n\topenDocutheque( element ) {\n\t\tconst docuthequeId = parseInt( element.getAttribute( 'href' ).replace( '#docutheque-', '' ), 10 );\n\t\tconst docuthequePagination = find( this.pagination, { parent: docuthequeId } );\n\n\t\tif ( docuthequePagination && docuthequePagination.parent ) {\n\t\t\tthis.updatePagination( docuthequePagination.parent, 1, docuthequePagination.totalItems, docuthequePagination.totalPages );\n\t\t}\n\n\t\tthis.itemsContainer.innerHTML = '<li class=\"loading\"</li>';\n\n\t\treturn this.fetchItems( docuthequeId )\n\t}\n\n\tfetchItems( parentID ) {\n\t\tconst children = filter( this.dossiers, { parent: parentID } );\n\t\tconst { by, order } = this.orderBy;\n\t\tthis.current = parentID;\n\t\tlet ancestors = [];\n\t\tthis.breadCrumbs.innerHTML = '';\n\n\t\tif ( this.current !== this.docuThequeId ) {\n\t\t\tconst parents = this.getAllParents( parentID );\n\t\t\tconst current = find( this.dossiers, ['id', parentID ] );\n\t\t\tconst BreadCrumbTemplate = this.getTemplate( 'docutheque-breadcrumbs' );\n\n\t\t\teachRight( parents, ( parent ) => {\n\t\t\t\tparent.link = '#dossier-' + parent.id;\n\t\t\t\tancestors = [ ...ancestors, parent ];\n\t\t\t} );\n\n\t\t\tancestors = [ ...ancestors, omit( current, ['link'] ) ];\n\n\t\t\tancestors.forEach( ( ancestor, index ) => {\n\t\t\t\tif ( 0 === index ) {\n\t\t\t\t\tthis.breadCrumbs.innerHTML = BreadCrumbTemplate( ancestor );\n\t\t\t\t} else {\n\t\t\t\t\tconst sousDossier = document.querySelector( '#sous-dossier-' + ancestors[ index - 1 ].id );\n\t\t\t\t\tsousDossier.innerHTML = BreadCrumbTemplate( ancestor );\n\t\t\t\t}\n\t\t\t} );\n\t\t}\n\n\t\tfetch( this.root + 'wp/v2/media?dossiers[]=' + parentID + '&per_page=20&docutheques_widget=1&context=view&orderby=' + by + '&order=' + order, {\n\t\t\tmethod: 'GET',\n\t\t\theaders: {\n\t\t\t\t'X-WP-Nonce' : this.nonce,\n\t\t\t}\n\t\t} ).then(\n\t\t\t( response ) => {\n\t\t\t\tif ( ! find( this.pagination, { parent: this.current } ) ) {\n\t\t\t\t\tthis.pagination = [ {\n\t\t\t\t\t\tparent: this.current,\n\t\t\t\t\t\tdisplayedPages: 1,\n\t\t\t\t\t\ttotalItems: parseInt( response.headers.get( 'X-WP-Total' ), 10 ),\n\t\t\t\t\t\ttotalPages: parseInt( response.headers.get( 'X-WP-TotalPages' ), 10 )\n\t\t\t\t\t}, ...this.pagination ];\n\t\t\t\t}\n\n\t\t\t\treturn response;\n\t\t\t}\n\t\t).then(\n\t\t\t( response ) => response.json()\n\t\t).then(\n\t\t\t( data ) => {\n\t\t\t\tconst results = concat( children, data );\n\t\t\t\tconst ItemTemplate = this.getTemplate( 'docutheque-element' );\n\t\t\t\tthis.itemsContainer.innerHTML = '';\n\n\t\t\t\tif ( results.length ) {\n\t\t\t\t\tresults.forEach( ( result ) => {\n\t\t\t\t\t\tthis.itemsContainer.innerHTML += ItemTemplate( result );\n\t\t\t\t\t} );\n\t\t\t\t} else {\n\t\t\t\t\tthis.itemsContainer.innerHTML = ItemTemplate( { noItems: this.noItems } );\n\t\t\t\t}\n\t\t} );\n\t}\n\n\tfetchMoreItems( parent, displayedPages, totalItems, totalPages ) {\n\t\tconst { by, order } = this.orderBy;\n\t\tthis.updatePagination( parent, displayedPages, totalItems, totalPages );\n\n\t\tfetch( this.root + 'wp/v2/media?dossiers[]=' + parent + '&per_page=20&page=' + displayedPages + '&docutheques_widget=1&context=view&orderby=' + by + '&order=' + order, {\n\t\t\tmethod: 'GET',\n\t\t\theaders: {\n\t\t\t\t'X-WP-Nonce' : this.nonce,\n\t\t\t}\n\t\t} ).then(\n\t\t\t( response ) => response.json()\n\t\t).then(\n\t\t\t( data ) => {\n\t\t\t\tconst ItemTemplate = this.getTemplate( 'docutheque-element' );\n\n\t\t\t\tif ( data.length ) {\n\t\t\t\t\tdata.forEach( ( result ) => {\n\t\t\t\t\t\tthis.itemsContainer.innerHTML += ItemTemplate( result );\n\t\t\t\t\t} );\n\t\t\t\t}\n\t\t} );\n\t}\n\n\tstart() {\n\t\tthis.docuTheque.addEventListener( 'click', ( e ) => {\n\t\t\tlet element = e.target;\n\n\t\t\tif ( 'A' !== element.nodeName && 'A' === element.parentNode.nodeName ) {\n\t\t\t\telement = element.parentNode;\n\t\t\t}\n\n\t\t\tif ( element.classList.contains( 'ouvre-dossier' ) ) {\n\t\t\t\te.preventDefault();\n\n\t\t\t\tthis.openDossier( element );\n\t\t\t} else if ( element.classList.contains( 'racine-docutheque' ) ) {\n\t\t\t\te.preventDefault();\n\n\t\t\t\tthis.openDocutheque( element );\n\t\t\t}\n\t\t} );\n\n\t\tthis.itemsContainer.addEventListener( 'scroll', ( e ) => {\n\t\t\tconst list = e.target;\n\t\t\tconst listedDocuments = list.querySelectorAll( '.docutheque-document' );\n\n\t\t\tif ( list.scrollHeight - list.scrollTop === list.clientHeight ) {\n\t\t\t\tconst { parent, displayedPages, totalItems, totalPages } = find( this.pagination, { parent: this.current } );\n\n\t\t\t\tif ( parent && listedDocuments.length !== totalItems ) {\n\t\t\t\t\tthis.fetchMoreItems( parent, displayedPages + 1, totalItems, totalPages );\n\t\t\t\t}\n\t\t\t}\n\t\t} );\n\t}\n};\n\nconst DocuThequesWidget = new Widget( DocuTheques.settings );\n\nif ( 'loading' === document.readyState ) {\n\tdocument.addEventListener( 'DOMContentLoaded', DocuThequesWidget.start() );\n} else {\n\tDocuThequesWidget.start();\n}\n"]}